<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Paddy Doctor</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
<div class="container" style="max-width:1000px;">

  <!-- HEADER -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <h1>üõ†Ô∏è Admin Dashboard</h1>
    <div style="display:flex; gap:12px;">
      <a href="/" target="_blank">View Live Site</a>
      <a href="/logout"
         style="color:#ef4444; font-weight:bold; padding:8px 16px; border:1px solid #ef4444; border-radius:6px;">
        Logout
      </a>
    </div>
  </div>

  <!-- FLASH -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash-msg">{{ messages[0] }}</div>
    {% endif %}
  {% endwith %}

  <!-- ================= ADD DISEASE ================= -->
  <div class="result-card" style="border-left-color:#2563eb; background:#eff6ff;">
    <h3>Add New Disease</h3>

   <form action="/admin/add" method="POST">

      <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px;">
        <input class="input-field" name="name" placeholder="Disease Name" required>

        <select class="input-field" name="type">
          <option>Fungal Disease</option>
          <option>Bacterial Disease</option>
          <option>Viral Disease</option>
          <option>Pest Infestation</option>
          <option>Nutrient Deficiency</option>
        </select>

        <select class="input-field" name="severity">
          <option>Low</option>
          <option>Medium</option>
          <option>High</option>
          <option>Critical</option>
        </select>
      </div>

      <select class="input-field" name="logic" style="margin-top:12px;">
        <option value="OR">OR</option>
        <option value="AND">AND</option>
      </select>

      <textarea class="input-field" name="description"
                placeholder="Disease description"
                style="margin-top:12px;"></textarea>

      <textarea class="input-field" name="management"
                placeholder="Management advice (one per line)"
                style="margin-top:12px;"
                required></textarea>

      <select class="input-field" name="symptoms" multiple
              style="margin-top:12px; height:150px;" required>
        {% for s in data.symptoms %}
          <option value="{{ s.id }}">{{ s.label }}</option>
        {% endfor %}
      </select>

      <button class="btn-analyze" style="margin-top:16px;">Save Disease</button>
    </form>
  </div>

  <!-- ================= ADD SYMPTOM ================= -->
  <div class="result-card" style="border-left-color:#10b981; background:#ecfdf5; margin-top:20px;">
    <h3>Add New Symptom</h3>

    <form action="/admin/symptom/add" method="POST" enctype="multipart/form-data">
      <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:12px;">
        <select class="input-field" name="category" required>
          <option value="leaf">Leaf</option>
          <option value="stem">Stem</option>
          <option value="panicle">Panicle</option>
          <option value="whole">Whole Plant / General</option>
        </select>

        <input class="input-field" name="id" placeholder="Symptom ID" required>
        <input class="input-field" name="label" placeholder="Label" required>
        <input class="input-field" type="file" name="image" accept=".png,.jpg,.jpeg,.webp">
      </div>

      <button class="btn-analyze" style="margin-top:14px;">Add Symptom</button>
    </form>
  </div>

  <!-- ================= MANAGE SYMPTOMS ================= -->
  <div style="margin-top:30px;">
    <h3>Manage Symptoms</h3>

    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#f8fafc;">
          <th>Category</th>
          <th>ID</th>
          <th>Label</th>
          <th>Image</th>
          <th style="text-align:center;">Action</th>
        </tr>
      </thead>

      <tbody>
      {% for cat_slug, items in categorized_symptoms.items() %}
        {% for s in items %}
        <tr>
          <td>{{ cat_slug }}</td>
          <td><code>{{ s.id }}</code></td>
          <td>{{ s.label }}</td>

          <td style="text-align:center;">
            {% if s.img %}
              <img src="{{ url_for('static', filename=s.img) }}"
                   style="width:40px;height:40px;object-fit:cover;border-radius:6px;">
            {% else %}
              <span style="font-size:0.8em;color:#64748b;">No image</span>
            {% endif %}
          </td>

          <td style="text-align:center; white-space:nowrap;">
          <button type="button" class="btn-view"
  onclick='openEditSymptomModal(
    "{{ cat_slug }}",
    "{{ s.id }}",
    {{ s.label|tojson }},
    {{ (s.img or "")|tojson }}
  )'>
  Edit
</button>



            <a class="btn-view btn-delete"
               href="/admin/symptom/delete/{{ s.id }}"
               onclick="return confirm('Delete {{ s.id }}?');">
              Delete
            </a>
          </td>
        </tr>
        {% endfor %}
      {% endfor %}
      </tbody>
    </table>
  </div>
 <div style="margin-top: 40px;">
      <h3>List of Diseases</h3>

      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; background:white; border:1px solid #e2e8f0;">
          <thead>
            <tr style="background:#f8fafc;">
              <th style="padding:12px; border-bottom:2px solid #e2e8f0; text-align:center;">Name</th>
              <th style="padding:12px; border-bottom:2px solid #e2e8f0; text-align:center;">Type</th>
              <th style="padding:12px; border-bottom:2px solid #e2e8f0; text-align:center;">Severity</th>
              <th style="padding:12px; border-bottom:2px solid #e2e8f0; text-align:center;">Symptoms</th>
              <th style="padding:12px; border-bottom:2px solid #e2e8f0; text-align:center;">Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for disease in data.diseases %}
              <!-- Main Row -->
              <tr style="border-bottom:1px solid #e2e8f0; text-align:center;">
                <td style="padding:12px;"><strong>{{ disease.name }}</strong></td>
                <td style="padding:12px;">
                  <span style="font-size:0.85em; background:#f1f5f9; padding:2px 6px; border-radius:4px;">
                    {{ disease.type }}
                  </span>
                </td>
                <td style="padding:12px;">{{ disease.severity }}</td>
                <td style="padding:12px;">{{ disease.symptoms|length }} symptoms</td>
                <td style="padding:12px;">
                  <button type="button" class="btn-view" onclick="toggleDetails('{{ disease.id }}')">View</button>

                  <a class="btn-view btn-delete"
                     href="/admin/delete/{{ disease.id }}"
                     onclick="return confirm('Are you sure you want to delete {{ disease.name }}? This cannot be undone.');">
                    Delete
                  </a>
                </td>
              </tr>

              <!-- Hidden Details Row -->
              <tr id="details-{{ disease.id }}" class="details-row" style="display:none;">
                <td colspan="5">
                  <div class="details-content">
                    <!-- Management Column -->
                    <div class="details-box">
                      <span class="details-label">Management Advice</span>

                      {% if disease.management is string %}
                        <p style="white-space: pre-wrap; margin-top: 0;">{{ disease.management }}</p>
                      {% else %}
                        <ul style="margin-top:0; padding-left:20px;">
                          {% for m in disease.management %}
                            <li>{{ m }}</li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                    </div>

                    <!-- Symptoms Column -->
                    <div class="details-box">
                      <span class="details-label">Defined Symptoms</span>
                      <ul style="margin-top:0; padding-left:20px;">
                        {% for sym_id in disease.symptoms %}
                          {% for s_ref in data.symptoms %}
                            {% if s_ref.id == sym_id %}
                              <li>{{ s_ref.label }}</li>
                            {% endif %}
                          {% endfor %}
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
</div>

<!-- ================= EDIT MODAL ================= -->
<div id="editSymptomModal" class="modal-backdrop" style="display:none;">
  <div class="modal-card">
    <div class="modal-header">
      <h3>Edit Symptom</h3>
      <button type="button" class="modal-close" onclick="closeEditSymptomModal()">‚úï</button>

    </div>

    <form action="/admin/symptom/update" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="original_id" id="edit_original_id">
      <input type="hidden" name="original_category" id="edit_original_category">

      <select id="edit_category" name="category" class="input-field" required>
        <option value="leaf">Leaf</option>
        <option value="stem">Stem</option>
        <option value="panicle">Panicle</option>
        <option value="whole">Whole Plant / General</option>
      </select>

      <input id="edit_label" name="label" class="input-field" required>

      <div style="margin-top:8px;">
        <img id="edit_preview_img"
             style="width:60px;height:60px;border-radius:8px;display:none;">
      </div>

      <input type="file" name="image" class="input-field" accept=".png,.jpg,.jpeg,.webp">

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
        <button type="button" class="btn-view" onclick="closeEditSymptomModal()">Cancel</button>
        <button class="btn-analyze" style="width:auto;">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
function openEditSymptomModal(cat, id, label, img){
  document.getElementById("editSymptomModal").style.display = "flex";
  document.getElementById("edit_original_id").value = id;
  document.getElementById("edit_original_category").value = cat;
  document.getElementById("edit_category").value = cat;
  document.getElementById("edit_label").value = label;

  const imgEl = document.getElementById("edit_preview_img");
  if(img){
    imgEl.src = "{{ url_for('static', filename='') }}" + img;
    imgEl.style.display = "block";
  } else {
    imgEl.style.display = "none";
  }
}

function closeEditSymptomModal(){
  document.getElementById("editSymptomModal").style.display = "none";
}
</script>
<script>
function toggleDetails(id) {
  const row = document.getElementById('details-' + id);
  if (!row) return;

  row.style.display = (row.style.display === 'none' || row.style.display === '')
    ? 'table-row'
    : 'none';
}

function openEditSymptomModal(cat, id, label, img){
  document.getElementById("editSymptomModal").style.display = "flex";
  document.getElementById("edit_original_id").value = id;
  document.getElementById("edit_original_category").value = cat;
  document.getElementById("edit_category").value = cat;
  document.getElementById("edit_label").value = label;

  const imgEl = document.getElementById("edit_preview_img");
  if(img){
    imgEl.src = "{{ url_for('static', filename='') }}" + img;
    imgEl.style.display = "block";
  } else {
    imgEl.style.display = "none";
  }
}

function closeEditSymptomModal(){
  document.getElementById("editSymptomModal").style.display = "none";
}
</script>

</body>
</html>
